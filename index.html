<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEXA // Turbo Debug Mode</title>
    
   
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary: #ffffff;
            --accent: #007AFF; 
            --bg: #0a0a0c;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --font-main: 'Inter', -apple-system, sans-serif;
        }

        body { background: var(--bg); color: var(--primary); font-family: var(--font-main); padding: 40px 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .drop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .box { background: var(--card-bg); border: 2px dashed var(--border); border-radius: 12px; padding: 30px; text-align: center; position: relative; }
        .box input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        
        #queue { background: var(--card-bg); border-radius: 12px; padding: 20px; display: none; margin-bottom: 20px; }
        .item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        
        .bar-bg { width: 100px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 0 10px; }
        .bar-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.3s; }
        .status-tag { font-size: 0.8rem; font-weight: bold; color: var(--accent); }

        .btn { background: var(--primary); color: #000; border: none; padding: 15px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; }
        .btn:disabled { opacity: 0.3; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; margin-bottom: 40px;">
        <h1>VEXA <span style="font-size: 0.9rem; vertical-align: middle; background: var(--accent); padding: 4px 8px; border-radius: 4px;">DEBUG 1.2</span></h1>
        <p style="color: #888; margin-top: 10px;">Se travar em 0%, verifique o Console (F12)</p>
    </header>

    <div class="drop-grid">
        <div class="box"><h3>Imagens</h3><input type="file" id="img-in" multiple accept="image/*"></div>
        <div class="box"><h3>Áudios</h3><input type="file" id="aud-in" multiple accept="audio/*"></div>
    </div>

    <div id="queue">
        <div id="list"></div>
        <button id="start-btn" class="btn" style="margin-top: 20px;" disabled>GERAR VÍDEOS AGORA</button>
    </div>

    <div id="done" style="display: none; margin-top: 20px;">
        <button id="zip-btn" class="btn" style="background: var(--accent); color: #fff;">BAIXAR PACK .ZIP</button>
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ 
        log: true,
        corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
    });

    let filesImg = {}, filesAud = {}, results = [], activeName = "";

    // Listener de Progresso
    ffmpeg.setProgress(({ ratio }) => {
        if (activeName) {
            const p = Math.floor(ratio * 100);
            const fill = document.getElementById(`fill-${activeName}`);
            const txt = document.getElementById(`txt-${activeName}`);
            if (fill) fill.style.width = p + '%';
            if (txt) txt.innerText = p + '%';
        }
    });

    document.getElementById('img-in').onchange = e => loadFiles(e.target.files, 'img');
    document.getElementById('aud-in').onchange = e => loadFiles(e.target.files, 'aud');

    function loadFiles(list, type) {
        for (let f of list) {
            const n = f.name.split('.').slice(0, -1).join('.');
            type === 'img' ? filesImg[n] = f : filesAud[n] = f;
        }
        renderQueue();
    }

    function renderQueue() {
        const listDiv = document.getElementById('list');
        const pairs = Object.keys(filesAud).filter(n => filesImg[n]);
        listDiv.innerHTML = pairs.map(n => `
            <div class="item">
                <span>${n}.mp4</span>
                <div style="display:flex; align-items:center;">
                    <div class="bar-bg"><div class="bar-fill" id="fill-${n}"></div></div>
                    <span class="status-tag" id="txt-${n}">Aguardando</span>
                </div>
            </div>
        `).join('');
        document.getElementById('queue').style.display = pairs.length ? 'block' : 'none';
        document.getElementById('start-btn').disabled = !pairs.length;
    }

    document.getElementById('start-btn').onclick = async () => {
        const btn = document.getElementById('start-btn');
        btn.disabled = true;
        btn.innerText = "Carregando Engine...";

        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        const pairs = Object.keys(filesAud).filter(n => filesImg[n]);
        
        for (const n of pairs) {
            activeName = n;
            btn.innerText = `Processando: ${n}`;
            
            // Limpeza e Escrita
            ffmpeg.FS('writeFile', 'i_img', await fetchFile(filesImg[n]));
            ffmpeg.FS('writeFile', 'i_aud', await fetchFile(filesAud[n]));

            try {
                // Comando Ultra-Resiliente
                await ffmpeg.run(
                    '-loop', '1',
                    '-i', 'i_img',
                    '-i', 'i_aud',
                    '-c:v', 'libx264',
                    '-preset', 'ultrafast',
                    '-tune', 'stillimage',
                    '-vf', 'scale=trunc(iw/2)*2:trunc(ih/2)*2,format=yuv420p', // Garante dimensões pares (essencial p/ H264)
                    '-c:a', 'aac',
                    '-shortest',
                    'out.mp4'
                );

                const data = ffmpeg.FS('readFile', 'out.mp4');
                results.push({ name: `${n}.mp4`, data });
                document.getElementById(`txt-${n}`).innerText = "PRONTO";
            } catch (err) {
                console.error("Erro no vídeo:", n, err);
                document.getElementById(`txt-${n}`).innerText = "ERRO";
            }
        }

        activeName = "";
        btn.innerText = "Tudo Concluído!";
        document.getElementById('done').style.display = 'block';
    };

    document.getElementById('zip-btn').onclick = async () => {
        const zip = new JSZip();
        results.forEach(r => zip.file(r.name, r.data.buffer));
        const b = await zip.generateAsync({ type: "blob" });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = "vexa_export.zip";
        a.click();
    };
</script>

</body>
</html>
