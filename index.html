<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEXA // Light Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { background: #0a0a0c; color: white; font-family: sans-serif; padding: 20px; text-align: center; }
        .card { background: #1a1a1c; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        .btn { background: #007AFF; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold; }
        #log { background: #000; color: #0f0; padding: 15px; border-radius: 5px; text-align: left; font-size: 12px; height: 200px; overflow-y: auto; margin-top: 20px; border: 1px solid #0f0; }
    </style>
</head>
<body>

<div style="max-width: 500px; margin: 0 auto;">
    <h1>VEXA LIGHT</h1>
    <div class="card">
        <input type="file" id="f-img" multiple accept="image/*" style="margin-bottom:10px;">
        <input type="file" id="f-aud" multiple accept="audio/*">
    </div>
    <button id="run" class="btn">INICIAR PROCESSAMENTO</button>
    <div id="log">Aguardando arquivos...</div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    let imgs = {}, auds = {}, results = [];

    const log = (m) => {
        const d = document.getElementById('log');
        d.innerHTML += `<div>> ${m}</div>`;
        d.scrollTop = d.scrollHeight;
    };

    document.getElementById('f-img').onchange = e => { for(let f of e.target.files) imgs[f.name.split('.')[0]] = f; log("Fotos OK"); };
    document.getElementById('f-aud').onchange = e => { for(let f of e.target.files) auds[f.name.split('.')[0]] = f; log("Ãudios OK"); };

    document.getElementById('run').onclick = async () => {
        const btn = document.getElementById('run');
        btn.disabled = true;
        
        try {
            if (!ffmpeg.isLoaded()) {
                log("Iniciando Motor (Isso pode demorar)...");
                await ffmpeg.load();
            }

            const pairs = Object.keys(auds).filter(n => imgs[n]);
            log(`Total para processar: ${pairs.length}`);

            for (let n of pairs) {
                log(`Processando: ${n}...`);
                
                // Grava arquivos
                ffmpeg.FS('writeFile', 'i.png', await fetchFile(imgs[n]));
                ffmpeg.FS('writeFile', 'i.mp3', await fetchFile(auds[n]));

                // Executa com configuraÃ§Ãµes de baixo consumo
                await ffmpeg.run(
                    '-loop', '1',
                    '-i', 'i.png',
                    '-i', 'i.mp3',
                    '-c:v', 'libx264',
                    '-preset', 'ultrafast',
                    '-tune', 'stillimage',
                    '-vf', 'scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,format=yuv420p',
                    '-c:a', 'aac',
                    '-b:a', '96k', 
                    '-shortest',
                    'o.mp4'
                );

                results.push({ n: `${n}.mp4`, d: ffmpeg.FS('readFile', 'o.mp4') });
                
                // LIMPEZA CRÃTICA: Libera memÃ³ria apÃ³s cada vÃ­deo
                ffmpeg.FS('unlink', 'i.png');
                ffmpeg.FS('unlink', 'i.mp3');
                ffmpeg.FS('unlink', 'o.mp4');
                
                log(`âœ… ConcluÃ­do: ${n}`);
            }

            log("Gerando arquivo final...");
            const zip = new JSZip();
            results.forEach(r => zip.file(r.n, r.d.buffer));
            const blob = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "vexa_batch.zip";
            a.click();
            log("ðŸš€ Download enviado!");

        } catch (err) {
            log(`ERRO DE MEMÃ“RIA: Tente processar menos arquivos ou fechar outras abas.`);
            console.error(err);
        } finally {
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
