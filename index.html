<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEXA // Universal Engine</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root { --primary: #007AFF; --bg: #0a0a0c; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        input[type="file"] { margin: 10px 0; display: block; width: 100%; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn:disabled { opacity: 0.3; }
        #log { font-size: 12px; color: #888; margin-top: 20px; text-align: left; max-height: 150px; overflow-y: auto; background: #000; padding: 10px; border-radius: 5px; }
        .progress-item { margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>VEXA V1</h1>
    <p>Se n√£o funcionar agora, o console nos dir√° o porqu√™.</p>

    <div class="card">
        <label>1. Fotos (JPG/PNG)</label>
        <input type="file" id="files-img" multiple>
        
        <label>2. √Åudios (MP3)</label>
        <input type="file" id="files-aud" multiple>
    </div>

    <button id="btn-run" class="btn">GERAR V√çDEOS</button>
    
    <div id="status-list"></div>
    <div id="log">Console de Log: Aguardando...</div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    
    // Inicializa√ß√£o Simples (Sem multithreading para garantir compatibilidade)
    const ffmpeg = createFFmpeg({ log: true });

    let imgData = {}, audData = {}, results = [];

    // Fun√ß√£o para escrever no log da tela
    function writeLog(msg) {
        const logDiv = document.getElementById('log');
        logDiv.innerHTML += `<br>> ${msg}`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    document.getElementById('files-img').onchange = e => {
        for(let f of e.target.files) imgData[f.name.split('.')[0]] = f;
        writeLog(`Fotos carregadas: ${e.target.files.length}`);
    };

    document.getElementById('files-aud').onchange = e => {
        for(let f of e.target.files) audData[f.name.split('.')[0]] = f;
        writeLog(`√Åudios carregados: ${e.target.files.length}`);
    };

    document.getElementById('btn-run').onclick = async () => {
        const btn = document.getElementById('btn-run');
        btn.disabled = true;
        
        try {
            if (!ffmpeg.isLoaded()) {
                writeLog("Carregando motor FFmpeg...");
                await ffmpeg.load();
            }

            const pairs = Object.keys(audData).filter(name => imgData[name]);
            writeLog(`Pares encontrados: ${pairs.length}`);

            for (let name of pairs) {
                writeLog(`Processando: ${name}...`);
                
                // Limpar e Carregar arquivos na mem√≥ria virtual
                ffmpeg.FS('writeFile', 'pic.png', await fetchFile(imgData[name]));
                ffmpeg.FS('writeFile', 'sound.mp3', await fetchFile(audData[name]));

                // COMANDO DE SEGURAN√áA:
                // -vf scale: Garante que a imagem tenha dimens√µes pares (essencial)
                // -shortest: Para o v√≠deo quando o √°udio acaba
                await ffmpeg.run(
                    '-loop', '1',
                    '-i', 'pic.png',
                    '-i', 'sound.mp3',
                    '-c:v', 'libx264',
                    '-tune', 'stillimage',
                    '-preset', 'ultrafast',
                    '-vf', 'scale=trunc(iw/2)*2:trunc(ih/2)*2', 
                    '-pix_fmt', 'yuv420p',
                    '-c:a', 'aac',
                    '-shortest',
                    'out.mp4'
                );

                const data = ffmpeg.FS('readFile', 'out.mp4');
                results.push({ name: `${name}.mp4`, data });
                writeLog(`‚úÖ ${name} conclu√≠do!`);
            }

            writeLog("Finalizando pacote ZIP...");
            const zip = new JSZip();
            results.forEach(r => zip.file(r.name, r.data.buffer));
            const blob = await zip.generateAsync({type:"blob"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = "videos_vexa.zip";
            a.click();
            writeLog("üöÄ Download iniciado!");

        } catch (e) {
            writeLog(`‚ùå ERRO CR√çTICO: ${e.message}`);
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    };
</script>

</body>
</html>
