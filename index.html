<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>VEXA // Native Engine</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 40px; }
        .box { background: #111; border: 1px solid #333; padding: 25px; border-radius: 15px; display: inline-block; width: 350px; }
        button { background: #007AFF; color: #fff; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        #log { margin-top: 20px; color: #0f0; font-family: monospace; text-align: left; background: #000; padding: 15px; height: 160px; overflow-y: auto; font-size: 11px; }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="box">
    <h2>VEXA <span style="color:#007AFF">NATIVE</span></h2>
    <p style="font-size: 11px; color: #888;">Renderização via MediaStream (Sem erro de RAM)</p>
    <input type="file" id="f-img" accept="image/*"><br><br>
    <input type="file" id="f-aud" accept="audio/*">
    <button id="btn-run">GERAR VÍDEO</button>
</div>

<div id="log">> Aguardando arquivos...</div>
<canvas id="canvas" width="1280" height="720"></canvas>

<script>
    const log = (m) => { document.getElementById('log').innerHTML += `<div>> ${m}</div>`; };

    document.getElementById('btn-run').onclick = async () => {
        const imgFile = document.getElementById('f-img').files[0];
        const audFile = document.getElementById('f-aud').files[0];

        if (!imgFile || !audFile) return log("Selecione os arquivos!");

        log("Iniciando render nativo...");

        // 1. Carregar Áudio e Imagem
        const audio = new Audio(URL.createObjectURL(audFile));
        const img = new Image();
        img.src = URL.createObjectURL(imgFile);

        await new Promise(r => img.onload = r);
        log("Recursos carregados.");

        // 2. Configurar Canvas
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Desenhar imagem no canvas
        ctx.drawImage(img, 0, 0, 1280, 720);

        // 3. Capturar Stream e Gravar
        const stream = canvas.captureStream(1); // 1 FPS para economizar
        const audioStream = audio.captureStream ? audio.captureStream() : audio.mozCaptureStream();
        
        const combined = new MediaStream([...stream.getTracks(), ...audioStream.getAudioTracks()]);
        const recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp8', bitsPerSecond: 2500000 });
        
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "video_vexa.webm";
            a.click();
            log("✅ Vídeo gerado com sucesso!");
        };

        // 4. Iniciar Processo
        recorder.start();
        audio.play();
        log("Gravando áudio... (Aguarde o fim da música)");

        audio.onended = () => {
            recorder.stop();
            log("Finalizando arquivo...");
        };
    };
</script>
</body>
</html>
