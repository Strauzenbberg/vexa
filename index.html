<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>VEXA // Final Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.9.0/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 40px; }
        .box { background: #111; border: 1px solid #333; padding: 25px; border-radius: 15px; display: inline-block; width: 320px; }
        #btn-run { background: #007AFF; color: #fff; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        #log { margin-top: 20px; color: #0f0; font-family: monospace; text-align: left; background: #000; padding: 15px; border: 1px solid #222; height: 160px; overflow-y: auto; font-size: 11px; }
        input { font-size: 12px; margin-bottom: 10px; width: 100%; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="margin-top:0">VEXA <span style="color:#007AFF">FIX</span></h2>
    <input type="file" id="f-img" multiple accept="image/*">
    <input type="file" id="f-aud" multiple accept="audio/*">
    <button id="btn-run">GERAR AGORA</button>
</div>

<div id="log">Console: Pronto para iniciar.</div>

<script>
    // ReferÃªncia direta para evitar erros de escopo
    const ffmpeg = window.FFmpeg.createFFmpeg({ 
        log: true,
        // ForÃ§amos o carregamento de arquivos especÃ­ficos para evitar o "Failed to fetch"
        corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.9.0/dist/ffmpeg-core.js'
    });

    const logDiv = document.getElementById('log');
    function writeLog(msg) {
        logDiv.innerHTML += `<div>> ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    let imgs = {}, auds = {}, results = [];

    document.getElementById('f-img').onchange = e => { 
        for(let f of e.target.files) imgs[f.name.split('.')[0]] = f;
        writeLog("Fotos processadas.");
    };

    document.getElementById('f-aud').onchange = e => { 
        for(let f of e.target.files) auds[f.name.split('.')[0]] = f;
        writeLog("Ãudios processados.");
    };

    document.getElementById('btn-run').onclick = async () => {
        const btn = document.getElementById('btn-run');
        btn.disabled = true;
        
        try {
            if (!ffmpeg.isLoaded()) {
                writeLog("Baixando motor da CDN...");
                await ffmpeg.load();
                writeLog("Motor carregado com sucesso!");
            }

            const pairs = Object.keys(auds).filter(n => imgs[n]);
            if (pairs.length === 0) {
                writeLog("Erro: Nomes de arquivos nÃ£o coincidem.");
                btn.disabled = false;
                return;
            }

            for (const n of pairs) {
                writeLog(`Criando vÃ­deo: ${n}`);
                
                ffmpeg.FS('writeFile', 'pic.png', await window.FFmpeg.fetchFile(imgs[n]));
                ffmpeg.FS('writeFile', 'snd.mp3', await window.FFmpeg.fetchFile(auds[n]));

                // Comando ultra-leve
                await ffmpeg.run(
                    '-loop', '1', '-i', 'pic.png', '-i', 'snd.mp3',
                    '-c:v', 'libx264', '-preset', 'ultrafast',
                    '-vf', 'scale=1280:720,format=yuv420p',
                    '-c:a', 'aac', '-shortest', 'out.mp4'
                );

                results.push({ n: n + ".mp4", d: ffmpeg.FS('readFile', 'out.mp4') });
                
                ffmpeg.FS('unlink', 'pic.png');
                ffmpeg.FS('unlink', 'snd.mp3');
                ffmpeg.FS('unlink', 'out.mp4');
                writeLog(`âœ… ${n} renderizado.`);
            }

            writeLog("Zipando tudo...");
            const zip = new JSZip();
            results.forEach(r => zip.file(r.n, r.d.buffer));
            const blob = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "vexa_pack.zip";
            a.click();
            writeLog("ðŸš€ Download iniciado!");

        } catch (err) {
            writeLog("ERRO: " + err.message);
            console.error(err);
        } finally {
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
